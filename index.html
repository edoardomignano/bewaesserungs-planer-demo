<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PVC WELT Planer – Step 1 (Bild + Pan/Zoom)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121926; --muted:#9aa4b2; --text:#e6edf3;
      --accent:#4cc9f0;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .title{font-weight:900;}
    .sub{color:var(--muted);font-size:12px;margin-top:2px;}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px;height:calc(100vh - 58px);}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;overflow:auto;}
    canvas{width:100%;height:100%;background:#070a10;border-radius:14px;border:1px solid rgba(255,255,255,.08);}
    h3{margin:0 0 10px;font-size:14px;color:#dbe7ff;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0;}
    input,button{background:#0f1520;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-size:13px;}
    button{cursor:pointer;}
    button.primary{border-color:rgba(76,201,240,.35);background:linear-gradient(135deg, rgba(76,201,240,.25), rgba(76,201,240,.08));}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0;}
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">PVC WELT Planer <span class="mono">Step 1</span></div>
    <div class="sub">Bild hochladen • Fit • Pan/Zoom (Space = Pan)</div>
  </div>
  <div class="row">
    <span class="hint">Status: <span id="status">kein Bild</span></span>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <h3>1) Bild (Plan) hochladen</h3>
    <div class="row">
      <input id="fileBg" type="file" accept="image/*" />
      <button id="btnFit" class="primary">Bild: Fit</button>
    </div>
    <div class="hint">Tipp: <span class="mono">Mausrad</span> zoom • <span class="mono">Space</span> gedrückt halten = Pan • Ziehen = Pan</div>

    <div class="sep"></div>

    <h3>Ansicht</h3>
    <div class="hint">
      Zoom: <span id="kZoom" class="mono">1.00</span><br>
      Offset: <span id="kOff" class="mono">0,0</span>
    </div>
  </div>

  <div class="panel" style="padding:10px;">
    <canvas id="c"></canvas>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const el = (id) => document.getElementById(id);

  // View (Weltkoordinaten = Bildpixel)
  let view = { x: 0, y: 0, s: 1 }; // x/y = world offset, s = zoom
  let mouse = { down:false, last:null };
  let spacePan = false;

  const state = {
    bg: { img:null, w:0, h:0, url:null }
  };

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function worldToScreen(p){ return { x:(p.x + view.x) * view.s, y:(p.y + view.y) * view.s }; }
  function screenToWorld(p){ return { x:p.x / view.s - view.x, y:p.y / view.s - view.y }; }

  function fitCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.floor(rect.width  * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    render();
  }
  window.addEventListener("resize", fitCanvas);

  function fitImageToView(){
    if(!state.bg.img) return;
    const rect = canvas.getBoundingClientRect();
    const vw = rect.width, vh = rect.height;
    const sx = (vw * 0.92) / state.bg.w;
    const sy = (vh * 0.92) / state.bg.h;
    view.s = clamp(Math.min(sx, sy), 0.15, 10);

    // Bild zentrieren
    const cx = state.bg.w / 2;
    const cy = state.bg.h / 2;
    view.x = (vw/(2*view.s)) - cx;
    view.y = (vh/(2*view.s)) - cy;
  }

  function render(){
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width,rect.height);

    // Bild zeichnen
    if(state.bg.img){
      const p0 = worldToScreen({x:0,y:0});
      ctx.drawImage(state.bg.img, p0.x, p0.y, state.bg.w*view.s, state.bg.h*view.s);
    } else {
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.08)";
      ctx.font = "14px system-ui";
      ctx.fillText("Bitte Bild hochladen…", 16, 28);
      ctx.restore();
    }

    // kleine HUD Werte
    el("kZoom").textContent = view.s.toFixed(2);
    el("kOff").textContent = `${view.x.toFixed(1)}, ${view.y.toFixed(1)}`;
  }

  // Upload
  el("fileBg").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if(!file) return;

    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      state.bg.img = img;
      state.bg.w = img.width;
      state.bg.h = img.height;
      state.bg.url = url;

      el("status").textContent = `Bild geladen (${img.width}×${img.height})`;
      fitImageToView();
      render();
    };
    img.src = url;
  });

  el("btnFit").addEventListener("click", () => {
    fitImageToView();
    render();
  });

  // Pan + Zoom
  window.addEventListener("keydown", (e) => { if(e.code === "Space") spacePan = true; });
  window.addEventListener("keyup",   (e) => { if(e.code === "Space") spacePan = false; });

  canvas.addEventListener("mousedown", (e) => {
    mouse.down = true;
    mouse.last = { x:e.offsetX, y:e.offsetY };
  });
  window.addEventListener("mouseup", () => { mouse.down = false; mouse.last = null; });

  canvas.addEventListener("mousemove", (e) => {
    if(!mouse.down) return;
    // Ziehen = Pan (immer) + Space ist nur als Hinweis (wie “Pro-Tool”)
    const dx = (e.offsetX - mouse.last.x) / view.s;
    const dy = (e.offsetY - mouse.last.y) / view.s;
    view.x += dx;
    view.y += dy;
    mouse.last = { x:e.offsetX, y:e.offsetY };
    render();
  });

  canvas.addEventListener("wheel", (e) => {
    e.preventDefault();
    const zoom = Math.exp(-e.deltaY * 0.0012);
    const mx = e.offsetX, my = e.offsetY;

    const before = screenToWorld({x:mx, y:my});
    view.s = clamp(view.s * zoom, 0.15, 10);
    const after = screenToWorld({x:mx, y:my});

    // zoom um Mausposition herum
    view.x += (after.x - before.x);
    view.y += (after.y - before.y);

    render();
  }, {passive:false});

  // Init
  fitCanvas();
  render();
})();
</script>
</body>
</html>
